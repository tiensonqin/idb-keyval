"use strict";var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){return function r(i,o){try{var u=t[i](o),s=u.value}catch(e){return void n(e)}if(!u.done)return Promise.resolve(s).then(function(e){r("next",e)},function(e){r("throw",e)});e(s)}("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var idbKeyval=function(e){var t=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"keyval-store",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"keyval";_classCallCheck(this,e),this.storeName=n,this._dbName=t,this._storeName=n,this.id="dbName:"+t+";;storeName:"+n,this._init()}return _createClass(e,[{key:"_init",value:function(){var e=this;this._dbp||(this._dbp=new Promise(function(t,n){var r=indexedDB.open(e._dbName);r.onerror=function(){return n(r.error)},r.onsuccess=function(){return t(r.result)},r.onupgradeneeded=function(){r.result.createObjectStore(e._storeName)}}))}},{key:"_withIDBStore",value:function(e,t){var n=this;return this._init(),this._dbp.then(function(r){return new Promise(function(i,o){var u=r.transaction(n.storeName,e);u.oncomplete=function(){return i()},u.onabort=u.onerror=function(){return o(u.error)},t(u.objectStore(n.storeName))})})}},{key:"_close",value:function(){var e=this;return this._init(),this._dbp.then(function(t){t.close(),e._dbp=void 0})}}]),e}(),n=function(){function e(t){_classCallCheck(this,e),this.executor=t,this.items=[]}return _createClass(e,[{key:"process",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.items,this.items=[],e.next=4,this.executor(t.map(function(e){return e.item}));case 4:t.map(function(e){return(0,e.onProcessed)()}),this.items.length?this.ongoing=this.process():this.ongoing=void 0;case 6:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"queue",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new Promise(function(e){return r.items.push({item:t,onProcessed:e})}),this.ongoing||(this.ongoing=this.process()),e.abrupt("return",n);case 3:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}(),r=void 0;function i(){return r||(r=new t),r}var o={};return e.Store=t,e.get=function(e){var t=void 0;return(arguments.length>1&&void 0!==arguments[1]?arguments[1]:i())._withIDBStore("readwrite",function(n){t=n.get(e)}).then(function(){return t.result})},e.set=function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:i();return o[r.id]||(o[r.id]=new n(function(e){return r._withIDBStore("readwrite",function(t){var n=!0,r=!1,i=void 0;try{for(var o,u=e[Symbol.iterator]();!(n=(o=u.next()).done);n=!0){var s=o.value;t.put(s.value,s.key)}}catch(e){r=!0,i=e}finally{try{!n&&u.return&&u.return()}finally{if(r)throw i}}})})),o[r.id].queue({key:e,value:t})},e.update=function(e,t){return(arguments.length>2&&void 0!==arguments[2]?arguments[2]:i())._withIDBStore("readwrite",function(n){var r=n.get(e);r.onsuccess=function(){n.put(t(r.result),e)}})},e.del=function(e){return(arguments.length>1&&void 0!==arguments[1]?arguments[1]:i())._withIDBStore("readwrite",function(t){t.delete(e)})},e.clear=function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:i())._withIDBStore("readwrite",function(e){e.clear()})},e.keys=function(){var e=[];return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:i())._withIDBStore("readwrite",function(t){(t.openKeyCursor||t.openCursor).call(t).onsuccess=function(){this.result&&(e.push(this.result.key),this.result.continue())}}).then(function(){return e})},e.close=function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:i())._close()},e}({});
